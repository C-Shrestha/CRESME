

@model IEnumerable<CRESME.Data.Attempt>

@{
    ViewData["Title"] = "Quiz Details";
}

<h1>Quiz Details Page</h1>

<br />
<br />


<div id="accordion">
    <div class="card">

        <div class="card-header" id="headingOne">
            <h5 class="mb-0">
                <button class="btn btn-outline-success" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                    Quiz Statistics
                </button>
            </h5>
        </div>

        <div id="collapseOne" class="collapse show" aria-labelledby="headingOne" data-bs-parent="#accordion">
            <div class="card-body">


                @{
                    double total = 0.0;
                    double num = 0.0;
                    double average = 0.0;
                    double maxScore  = 0.0;
                    double minScore = 0.0;
                    double medianValue = 0.0;

                    List<double> scoreList = new List<double>();
                    List<TimeSpan> durations = new List<TimeSpan>();
                    TimeSpan totalDuration = TimeSpan.Zero;
                    TimeSpan averageDuration = TimeSpan.Zero;



                    foreach(var item in Model)
                    {
                        total += (double)item.Score;
                        num++;
                        scoreList.Add((double)item.Score);
                        TimeSpan x = (item.EndTime - item.StartTime); 
                        durations.Add(x);
                        totalDuration += x;


                    }

                    if (!scoreList.Any())
                    {
                        throw new Exception("No quiz data. No Student has taken the quiz yet.");
                    }

                    if (scoreList.Any())
                    {   

                        average = total / num;

                        // You can convert it back to an array if you would like to
                        double[] scores = scoreList.ToArray();

                        static double GetMedian(double[] scoreNumbers)
                        {
                            //Framework 2.0 version of this method. there is an easier way in F4
                            if (scoreNumbers == null || scoreNumbers.Length == 0)
                            {

                                return 0;
                            }
                            //throw new System.Exception("Median of empty array not defined.");

                            //make sure the list is sorted, but use a new array

                            else
                            {
                                double[] sortedPNumbers = (double[])scoreNumbers.Clone();
                                Array.Sort(sortedPNumbers);

                                //get the median
                                int size = sortedPNumbers.Length;
                                int mid = size / 2;
                                double median = (size % 2 != 0) ? (double)sortedPNumbers[mid] : ((double)sortedPNumbers[mid] + (double)sortedPNumbers[mid - 1]) / 2;
                                return median;
                            }

                        }

                         medianValue = GetMedian(scores);



                        // Calculate the average duration
                        //TimeSpan averageDuration = TimeSpan.FromTicks(totalDuration.Ticks / durations.Count);

                         averageDuration = (durations.Count > 0) ? TimeSpan.FromTicks(totalDuration.Ticks / durations.Count) : TimeSpan.Zero;

                    }


                }

                <p>
                    <b>Student Count:</b> @num<br />
                </p>
                
                <p>
                    <b>Mean Score:</b>  @average    <br />
                    <b>Median Score: </b>  @medianValue <br />
                </p>

                <p>
                    <b>Maximum Score:</b> @maxScore    <br />
                    <b>Minimum Score:</b> @minScore    <br />
                </p>

                <p>
                    <b>Mean Time (minutes):</b>  @averageDuration.TotalMinutes   minute(s)  <br />
                    <b>Mean Time (hours):</b>    @averageDuration.TotalHours     hour(s)    <br />
                </p>
                
                
                
            </div>
        </div>

    </div>


    <div class="card">

        <div class="card-header" id="studentData">
            <h5 class="mb-0">
                <button class="btn btn-outline-success collapsed" data-bs-toggle="collapse" data-bs-target="#collapseStudentData" aria-expanded="false" aria-controls="collapseStudentData">
                    Quiz Data
                </button>
            </h5>
        </div>

        <div id="collapseStudentData" class="collapse" aria-labelledby="studentData" data-bs-parent="#accordion">
            <div class="card-body">

                
                <br />
                <br />
                <br />

                <div class="table-responsive">

                    <table class="table table-hover table-bordered" id="dataTableData" width="100%" cellspacing="0">


                        <thead>
                            <tr>

                                <th>
                                    NID
                                </th>
                                <th>
                                    Name
                                </th>

                                <th>
                                    @Html.DisplayNameFor(model => model.Block)
                                </th>

                                <th>
                                    @Html.DisplayNameFor(model => model.Course)
                                </th>

                                <th>
                                    @Html.DisplayNameFor(model => model.Term)
                                </th>

                                <th>
                                    @Html.DisplayNameFor(model => model.Score)
                                </th>


                                @*DO NOT delete the empty tags below, they are needed for dataTable column counts to be equal between "thead" and "tbody"*@
                                @*<th></th>
                                <th></th>
                                <th></th>
                                *@

                            </tr>
                        </thead>




                        <tbody>

                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.StudentNID)
                                    </td>

                                    <td>
                                        @Html.DisplayFor(modelItem => item.StudentName)
                                    </td>

                                    <td>
                                        @Html.DisplayFor(modelItem => item.Block)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.Course)
                                    </td>

                                    <td>
                                        @Html.DisplayFor(modelItem => item.Term)
                                    </td>

                                    <td>
                                        @Html.DisplayFor(modelItem => item.Score)
                                    </td>


                                </tr>
                            }

                        </tbody>

                    </table>

                </div>


                <br />
                <br />
                <br />

            </div>
        </div>

    </div>


    <div class="card">

        <div class="card-header" id="headingTwo">
            <h5 class="mb-0">
                <button class="btn btn-outline-success collapsed" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                    Download Quiz Data
                </button>
            </h5>
        </div>

        <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-bs-parent="#accordion">
            <div class="card-body">
                <br />
                <form asp-controller="Admin" asp-action="QuizDetailsToExcel">

                    <input type="hidden" id="name" name="QuizName" value="@Model.FirstOrDefault().QuizName"/>
                    <button type="submit" class="btn btn-md btn-primary">
                        <i class="fa-solid fa-file-arrow-down"></i>
                        Export Quiz Data
                    </button>
                </form>
                <br />

            </div>
        </div>

    </div>

    <div class="card">

        <div class="card-header" id="headingThree">
            <h5 class="mb-0">
                <button class="btn btn-outline-success collapsed" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                    Download Quiz
                </button>
            </h5>
        </div>

        <div id="collapseThree" class="collapse" aria-labelledby="headingThree" data-bs-parent="#accordion">
            <div class="card-body">

                <br />
                <form asp-controller="Admin" asp-action="ExportQuizFromDetails">
                    <input type="hidden" id="name" name="QuizName" value="@Model.FirstOrDefault().QuizName" />
                    <button type="submit" class="btn btn-md btn-primary">
                        <i class="fa-solid fa-file-arrow-down"></i>
                        Export Quiz
                    </button>
                </form>
                <br />

            </div>
        </div>

    </div>


</div>

<br />
<br />
<br />


@section scripts
{
    <script src="~/js/datatable_file.js"></script>
}
